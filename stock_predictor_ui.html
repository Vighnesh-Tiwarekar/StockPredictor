<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Sentiment Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-button { transition: background-color 0.3s, color 0.3s; }
        .tab-button.active { background-color: #6d37d1; color: white; }
        .tab-button:not(.active):hover { background-color: #e0e7ff; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-checked { background-color: #d1fae5; color: #065f46; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        .score-label { font-size: 0.8rem; color: #a5b4fc; } 
        .score-value { font-size: 1.5rem; font-weight: 700; color: #ffffff; line-height: 1; }
        .score-percentage { font-size: 0.9rem; font-weight: 500; color: #e0e7ff; } 
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ffffff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #log-output, #predict-log, #check-log { 
             white-space: pre-wrap; word-wrap: break-word; font-family: monospace;
             background-color: #1f2937; color: #d1d5db; padding: 1rem;
             border-radius: 0.375rem; max-height: 300px; overflow-y: auto;
             margin-top: 1rem; font-size: 0.8rem; line-height: 1.4;
        }
        .log-hidden { display: none; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        /* Style for date picker placeholder */
        input[type="date"]:invalid::-webkit-calendar-picker-indicator {
            opacity: 0.6;
        }
    </style>
</head>
<body class="">
    <div class="w-[100vw] mx-auto bg-white overflow-hidden">

        <header class="bg-gradient-to-r from-indigo-600 to-purple-700 p-4 sm:p-6 text-white flex justify-between items-center ">
            <h1 class="text-xl sm:text-2xl font-bold">📈 Stock Predictor</h1>
            <div id="reliability-score-display" class="text-right">
                <span class="score-label block">Global Reliability Score</span>
                <span class="score-value block">--</span>
                <span class="score-percentage block">(--%)</span>
            </div>
        </header>

        <nav class="flex border-b border-gray-200 bg-gray-50">
            <button id="tab-main" class="tab-button flex-1 py-3 px-4 text-center font-medium text-gray-700 active" onclick="showTab('main')">Predict & Check</button>
            <button id="tab-history" class="tab-button flex-1 py-3 px-4 text-center font-medium text-gray-700" onclick="showTab('history')">History</button>
            <button id="tab-scores" class="tab-button flex-1 py-3 px-4 text-center font-medium text-gray-700" onclick="showTab('scores')">Reliability Scores</button>
        </nav>

        <main class="p-4 sm:p-6">

            <div id="content-main">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">Generate New Prediction</h2>
                
                <div class="flex flex-col sm:flex-row gap-3 mb-6">
                    <input type="text" id="company-name-input" placeholder="Enter Company Name (e.g., Reliance)" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition duration-150">
                    
                    <div class="relative sm:w-1/3">
                         <label for="prediction-date-input" class="absolute -top-2 left-2 inline-block bg-white px-1 text-xs font-medium text-gray-500">Prediction For</label>
                         <input type="date" id="prediction-date-input" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition duration-150 text-gray-700">
                    </div>

                    <button id="predict-button" onclick="handlePredict()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-md transition duration-150 flex items-center justify-center">
                        <span>Run Prediction Pipeline</span>
                        <span id="predict-loader" class="loader hidden ml-2"></span>
                    </button>
                </div>
                <div id="predict-status" class="mt-4 text-sm text-gray-600 min-h-[40px] p-3 border border-gray-200 rounded-md bg-gray-50">Enter a company name, select a date, and click Run.</div>
                <pre id="predict-log" class="log-hidden"></pre>

                <hr class="my-6 border-gray-200">

                <h2 class="text-lg font-semibold mb-4 text-gray-800">Check Pending Predictions</h2>
                <p class="text-sm text-gray-600 mb-4">Click below to run the verifier script. This checks 'pending' predictions and updates the reliability score.</p>
                <button id="check-button" onclick="handleCheck()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-md transition duration-150 flex items-center justify-center">
                    <span>Check Pending & Update Score</span>
                     <span id="check-loader" class="loader hidden ml-2"></span>
                </button>
                 <div id="check-status" class="mt-4 text-sm text-gray-600 min-h-[40px] p-3 border border-gray-200 rounded-md bg-gray-50">Ready to check pending predictions.</div>
                 <pre id="check-log" class="log-hidden"></pre>
            </div>

            <div id="content-history" class="hidden">
                <h2 class="text-lg font-semibold mb-4 text-gray-800">Prediction History</h2>
                 <button onclick="loadHistory(true)" class="mb-4 text-sm text-indigo-600 hover:text-indigo-800 disabled:opacity-50 disabled:cursor-not-allowed" id="refresh-history-button">Refresh History</button>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Saved</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prediction</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Checked</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actual %</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score (/1.0)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="8" class="text-center p-4 text-gray-500">Loading history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="content-scores" class="hidden">
                 <h2 class="text-lg font-semibold mb-4 text-gray-800">Per-Company Reliability Scores</h2>
                 <button onclick="loadCompanyScores(true)" class="mb-4 text-sm text-indigo-600 hover:text-indigo-800 disabled:opacity-50 disabled:cursor-not-allowed" id="refresh-scores-button">Refresh Scores</button>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reliability Score</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Predictions</th>
                            </tr>
                        </thead>
                        <tbody id="company-scores-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="3" class="text-center p-4 text-gray-500">Loading scores...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = ''; 

        let allPredictions = [];
        let reliabilityScore = { total_predictions: 0, total_score_points: 0.0 };
        let isPredicting = false;
        let isChecking = false;

        // Get references to UI elements
        const predictButton = document.getElementById('predict-button');
        const checkButton = document.getElementById('check-button');
        const predictLoader = document.getElementById('predict-loader');
        const checkLoader = document.getElementById('check-loader');
        const predictStatusEl = document.getElementById('predict-status');
        const checkStatusEl = document.getElementById('check-status');
        const predictLogEl = document.getElementById('predict-log');
        const checkLogEl = document.getElementById('check-log');
        const historyTableBody = document.getElementById('history-table-body');
        const refreshHistoryButton = document.getElementById('refresh-history-button');
        const refreshScoresButton = document.getElementById('refresh-scores-button');
        const companyScoresTableBody = document.getElementById('company-scores-table-body');
        
        // --- NEW UI REFERENCE ---
        const predictionDateInput = document.getElementById('prediction-date-input');


        // --- UI Update Functions ---
        function updateButtonStates() {
            const busy = isPredicting || isChecking;
            predictButton.disabled = busy;
            checkButton.disabled = busy;
            refreshHistoryButton.disabled = busy; 
            refreshScoresButton.disabled = busy; 
            predictLoader.classList.toggle('hidden', !isPredicting);
            checkLoader.classList.toggle('hidden', !isChecking);
        }

        // (setStatus and showLog functions remain the same)
        function setStatus(element, message, type = 'info') {
            element.textContent = message;
            let bgColor = 'bg-gray-50';
            let textColor = 'text-gray-600';
            let borderColor = 'border-gray-200';

            if (type === 'success') {
                bgColor = 'bg-green-50'; textColor = 'text-green-700'; borderColor = 'border-green-200';
            } else if (type === 'error') {
                bgColor = 'bg-red-50'; textColor = 'text-red-700'; borderColor = 'border-red-200';
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-50'; textColor = 'text-yellow-700'; borderColor = 'border-yellow-200';
            } else if (type === 'loading') {
                 bgColor = 'bg-blue-50'; textColor = 'text-blue-700'; borderColor = 'border-blue-200';
            }
            element.className = `mt-4 text-sm p-3 border rounded-md min-h-[40px] ${bgColor} ${textColor} ${borderColor} whitespace-pre-wrap`;
        }
        function showLog(logElement, logText) {
            if (logText && logText.trim()) {
                logElement.textContent = logText.trim();
                logElement.classList.remove('log-hidden');
            } else {
                logElement.textContent = '';
                logElement.classList.add('log-hidden');
            }
        }

        // --- Tab Management ---
        function showTab(tabName) {
            // (Function remains the same)
            document.getElementById('content-main').classList.toggle('hidden', tabName !== 'main');
            document.getElementById('content-history').classList.toggle('hidden', tabName !== 'history');
            document.getElementById('content-scores').classList.toggle('hidden', tabName !== 'scores');
            document.getElementById('tab-main').classList.toggle('active', tabName === 'main');
            document.getElementById('tab-history').classList.toggle('active', tabName === 'history');
            document.getElementById('tab-scores').classList.toggle('active', tabName === 'scores');

            if (tabName === 'history') loadHistory(false);
            if (tabName === 'scores') loadCompanyScores(false);
            if (tabName === 'main') loadReliabilityScore(); 
        }

        // --- Data Fetching & Display ---
        // (loadReliabilityScore, loadHistory, loadCompanyScores functions remain the same)
        async function loadReliabilityScore() {
             try {
                const response = await fetch(`${API_BASE_URL}/api/score`, { cache: "no-store" });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const scoreData = await response.json();
                reliabilityScore.total_predictions = scoreData.total_predictions || 0;
                reliabilityScore.total_score_points = scoreData.total_score_points || 0.0;
                displayReliabilityScore();
            } catch (error) {
                console.error('Error loading reliability score:', error);
                displayReliabilityScore(); 
            }
        }
        async function loadHistory(forceRefresh = false) {
            if (isPredicting || isChecking) return;
            if (forceRefresh || historyTableBody.rows.length <= 1) {
                 historyTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">Loading history...</td></tr>';
            }
            try {
                const response = await fetch(`${API_BASE_URL}/api/history`, { cache: "no-store" });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const historyData = await response.json();
                if (!Array.isArray(historyData)) throw new Error('Invalid history format');
                allPredictions = historyData;
                renderHistoryTable();
            } catch (error) {
                console.error('Error loading prediction history:', error);
                historyTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-500">Error loading history: ${error.message}. Is the backend server running?</td></tr>`;
            }
        }
        async function loadCompanyScores(forceRefresh = false) {
             if (isPredicting || isChecking) return;
             if (forceRefresh || companyScoresTableBody.rows.length <= 1) {
                 companyScoresTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">Loading scores...</td></tr>';
             }
            try {
                const response = await fetch(`${API_BASE_URL}/api/score/all`, { cache: "no-store" });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const allScoreData = await response.json();
                if (!allScoreData || typeof allScoreData.companies !== 'object') {
                    throw new Error('Invalid score data format');
                }
                renderCompanyScoresTable(allScoreData.companies);
            } catch (error) {
                console.error('Error loading company scores:', error);
                companyScoresTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-red-500">Error loading scores: ${error.message}.</td></tr>`;
            }
        }
        
        // (displayReliabilityScore, renderHistoryTable, renderCompanyScoresTable, getPredictionEmoji, getResultLabel functions remain the same)
        function displayReliabilityScore() {
             const scoreDisplay = document.getElementById('reliability-score-display');
            let score = 0;
            let percentage = 0;
            if (reliabilityScore.total_predictions > 0) {
                score = reliabilityScore.total_score_points / reliabilityScore.total_predictions;
                percentage = score * 100;
            }
            scoreDisplay.querySelector('.score-value').textContent = score.toFixed(3);
            scoreDisplay.querySelector('.score-percentage').textContent = `(${percentage.toFixed(1)}%)`;
        }
        function renderHistoryTable() {
            historyTableBody.innerHTML = '';
            if (allPredictions.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">No prediction history found.</td></tr>';
                return;
            }
            [...allPredictions].reverse().forEach(pred => {
                const row = historyTableBody.insertRow();
                const predictionScore = pred.prediction_score ?? null;
                const resultLabel = getResultLabel(predictionScore);
                const statusClass = pred.status === 'pending' ? 'status-pending' : (pred.status === 'error' ? 'status-error' : 'status-checked');
                const actualPercentText = (pred.actual_movement_percent !== undefined && pred.actual_movement_percent !== null)
                    ? pred.actual_movement_percent.toFixed(2) + '%' : '--';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${pred.company || 'N/A'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${pred.date_saved || 'N/A'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 font-semibold">${getPredictionEmoji(pred.prediction)} ${pred.prediction || 'N/A'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${pred.status || 'N/A'}</span></td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${pred.date_checked || '--'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${actualPercentText}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${predictionScore !== null ? predictionScore.toFixed(2) : '--'}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${resultLabel}</td>
                `;
            });
        }
        function renderCompanyScoresTable(companiesData) {
            companyScoresTableBody.innerHTML = '';
            const companyNames = Object.keys(companiesData);
            if (companyNames.length === 0) {
                companyScoresTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-500">No company-specific scores found. Run a prediction and check it.</td></tr>';
                return;
            }
            companyNames.sort().forEach(companyName => {
                const data = companiesData[companyName];
                const predictions = data.total_predictions || 0;
                const points = data.total_score_points || 0.0;
                let percentage = 0;
                if (predictions > 0) {
                    percentage = (points / predictions) * 100;
                }
                const displayName = companyName.charAt(0).toUpperCase() + companyName.slice(1);
                const row = companyScoresTableBody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${displayName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 font-semibold">${percentage.toFixed(1)}%</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${predictions}</td>
                `;
            });
        }
        function getPredictionEmoji(prediction) { 
             switch (prediction) { case 'rise': return '📈'; case 'fall': return '📉'; case 'neutral': return '➖'; default: return ''; }
        }
        function getResultLabel(score) { 
             if (score === null || score === undefined) return '--';
            if (score >= 0.9) return 'Excellent 👍👍'; if (score >= 0.7) return 'Good 👍';
            if (score >= 0.4) return 'Okay 👌'; if (score >= 0.2) return 'Poor 👎';
            return 'Incorrect 👎👎';
         }

        // --- Button Handlers (Actual API Calls) ---
        async function handlePredict() {
            // --- MODIFIED: Get date value and add to payload ---
             if (isPredicting || isChecking) return;
            const companyNameInput = document.getElementById('company-name-input');
            const companyName = companyNameInput.value.trim();
            const predictionDate = predictionDateInput.value; // Get date

            if (!companyName) {
                setStatus(predictStatusEl, '⚠️ Please enter a company name.', 'warning');
                showLog(predictLogEl, '');
                return;
            }
            
            if (!predictionDate) {
                setStatus(predictStatusEl, '⚠️ Please select a date for the prediction.', 'warning');
                showLog(predictLogEl, '');
                return;
            }

            isPredicting = true;
            updateButtonStates();
            // Updated status message
            setStatus(predictStatusEl, `⏳ Running prediction pipeline for ${companyName} for date ${predictionDate}... This may take several minutes.`, 'loading');
            showLog(predictLogEl, ''); 

            try {
                const response = await fetch(`${API_BASE_URL}/api/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Add prediction_date to the body
                    body: JSON.stringify({ 
                        company_name: companyName,
                        prediction_date: predictionDate 
                    })
                });
                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.message || `HTTP error ${response.status}`, { cause: result.log });
                }

                setStatus(predictStatusEl, `✅ ${result.message}`, 'success');
                companyNameInput.value = ''; // Clear input on success
                predictionDateInput.value = ''; // Clear date on success
                loadReliabilityScore();
                loadHistory(true); 

            } catch (error) {
                console.error('Prediction error:', error);
                setStatus(predictStatusEl, `❌ Error: ${error.message}. Check Flask terminal for details.`, 'error');
                showLog(predictLogEl, error.cause || `Error details unavailable. Check Flask terminal.`); 

            } finally {
                isPredicting = false;
                updateButtonStates();
            }
            // --- END MODIFICATION ---
        }

        async function handleCheck() {
             // (Function remains the same)
            if (isPredicting || isChecking) return;

            isChecking = true;
            updateButtonStates();
            setStatus(checkStatusEl, '⏳ Running verifier script...', 'loading');
            showLog(checkLogEl, '');

            try {
                const response = await fetch(`${API_BASE_URL}/api/check`, { method: 'POST' });
                const result = await response.json();

                 if (!response.ok || !result.success) {
                     if (result.updated_score) reliabilityScore = result.updated_score;
                     if (result.updated_history) allPredictions = result.updated_history;
                     displayReliabilityScore();
                     renderHistoryTable();
                     loadCompanyScores(true); 
                    throw new Error(result.message || `HTTP error ${response.status}`, { cause: result.log });
                }

                setStatus(checkStatusEl, `✅ ${result.summary || result.message}`, 'success');

                if (result.updated_score) reliabilityScore = result.updated_score;
                if (result.updated_history) allPredictions = result.updated_history;
                displayReliabilityScore(); 
                renderHistoryTable(); 
                loadCompanyScores(true); 

            } catch (error) {
                console.error('Check error:', error);
                setStatus(checkStatusEl, `❌ Error: ${error.message}. Check Flask terminal.`, 'error');
                showLog(checkLogEl, error.cause || `Error details unavailable. Check Flask terminal.`);

            } finally {
                isChecking = false;
                updateButtonStates();
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadReliabilityScore(); 
            loadHistory(); 
            updateButtonStates(); 
        });

    </script>
</body>
</html>